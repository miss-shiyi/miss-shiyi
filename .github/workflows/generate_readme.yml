# -*- coding: utf-8 -*-
import argparse
import os
import re
from datetime import timezone
from github import Github, Auth, GithubException
from marko.ext.gfm import gfm as marko
from feedgen.feed import FeedGenerator
from lxml.etree import CDATA

# --- è§†è§‰ä¸å›¾æ ‡é…ç½® ---
MD_HEAD = """# ğŸŒ™ miss-shiyi's Digital Garden

> **"ä¸å±äºä»»ä½•äººï¼Œä¹Ÿä¸æ‹¥æœ‰ä»»ä½•äººï¼Œå‡å°‘æœŸå¾…ï¼Œå¥½å¥½ç”Ÿæ´»ï¼Œæ­¤ç¨‹å±±é«˜è·¯è¿œï¼Œæˆ‘ç•™ç»™è‡ªå·±ã€‚"**

![Status](https://img.shields.io/badge/Status-Automated-00FFD1?style=flat-square&logo=github-actions&logoColor=white) 
![Articles](https://img.shields.io/badge/Archive-Digital_Artifacts-white?style=flat-square&logo=read-the-docs&logoColor=black)
![RSS](https://img.shields.io/badge/RSS-Feed-orange?style=flat-square&logo=rss&logoColor=white)

---
"""

# ä¸ºä¸åŒ Label åŒ¹é…å›¾æ ‡çš„å­—å…¸ï¼ˆä½ å¯ä»¥æ ¹æ®è‡ªå·±çš„æ ‡ç­¾åç»§ç»­æ·»åŠ ï¼‰
LABEL_ICONS = {
    "Python": "ğŸ",
    "Life": "ğŸŒ±",
    "Automation": "ğŸ¤–",
    "Thought": "ğŸ’¡",
    "Code": "ğŸ’»",
    "Travel": "ğŸ–ï¸",
    "TODO": "ğŸ“",
}

BACKUP_DIR = "BACKUP"
ANCHOR_NUMBER = 5
TOP_ISSUES_LABELS = ["Top"]
TODO_ISSUES_LABELS = ["TODO"]
FRIENDS_LABELS = ["Friends"]
IGNORE_LABELS = FRIENDS_LABELS + TOP_ISSUES_LABELS + TODO_ISSUES_LABELS

def get_me(gh):
    me = os.getenv("GITHUB_NAME")
    return me if me else gh.get_user().login

def format_time(time):
    # è½¬æ¢ä¸ºæ›´åŠ æ–‡è‰ºçš„æ ¼å¼: Oct 24, 2023
    return time.strftime("%b %d, %Y")

def add_issue_info(issue, md):
    time_str = format_time(issue.created_at)
    # ä½¿ç”¨ä»£ç å—åŒ…è£¹æ—¥æœŸï¼Œå¢åŠ ç§‘æŠ€æ„Ÿ
    md.write(f"- `[{time_str}]` &nbsp; **[{issue.title}]({issue.html_url})** \n")

def add_md_label(repo, md_path, me):
    labels = repo.get_labels()
    with open(md_path, "a+", encoding="utf-8") as md:
        for label in labels:
            if label.name in IGNORE_LABELS:
                continue

            issues = repo.get_issues(labels=[label], state="open", sort="created", direction="desc")
            if issues.totalCount == 0:
                continue

            # åŒ¹é…å›¾æ ‡
            icon = LABEL_ICONS.get(label.name, "ğŸ”–")
            md.write(f"### {icon} {label.name}\n\n")
            
            for i, issue in enumerate(issues):
                if issue.user.login != me or issue.pull_request:
                    continue
                if i == ANCHOR_NUMBER:
                    md.write("<details><summary><i>âœ¨ View More Artifacts...</i></summary>\n\n")
                add_issue_info(issue, md)
            
            if issues.totalCount > ANCHOR_NUMBER:
                md.write("\n</details>\n")
            md.write("\n")

def add_md_top(repo, md_path, me):
    top_issues = repo.get_issues(labels=TOP_ISSUES_LABELS, state="open")
    if top_issues.totalCount > 0:
        with open(md_path, "a+", encoding="utf-8") as md:
            md.write("## ğŸ“Œ Featured / ç½®é¡¶æ–‡ç« \n")
            for issue in top_issues:
                if issue.user.login == me:
                    md.write(f"- **[{issue.title}]({issue.html_url})** ğŸŒŸ\n")
            md.write("\n---\n")

def add_md_recent(repo, md_path, me, limit=5):
    with open(md_path, "a+", encoding="utf-8") as md:
        md.write("## ğŸ•’ Recent Updates / æœ€è¿‘æ›´æ–°\n")
        issues = repo.get_issues(state="open", sort="updated")
        count = 0
        for issue in issues:
            if issue.user.login == me and not issue.pull_request:
                add_issue_info(issue, md)
                count += 1
                if count >= limit: break
        md.write("\n---\n")

def add_md_footer(md_path, me):
    with open(md_path, "a+", encoding="utf-8") as md:
        md.write("\n---\n")
        md.write(f"<p align='center'><i>Generated with â¤ï¸ by <a href='https://github.com/{me}/{me}'>Automation Bot</a></i></p>\n")
        md.write(f"<p align='center'><img src='https://profile-counter.glitch.me/{me}/count.svg' alt='Views'></p>\n")

def generate_rss_feed(repo, filename, me):
    fg = FeedGenerator()
    fg.id(repo.html_url)
    fg.title(f"{me}'s Digital Garden")
    fg.author({'name': me})
    fg.link(href=repo.html_url, rel='alternate')
    for issue in repo.get_issues(state="open"):
        if not issue.body or issue.user.login != me or issue.pull_request:
            continue
        fe = fg.add_entry()
        fe.id(issue.html_url)
        fe.title(issue.title)
        fe.link(href=issue.html_url)
        fe.published(issue.created_at.replace(tzinfo=timezone.utc))
        content = "".join(c for c in issue.body if ord(c) >= 32)
        fe.content(CDATA(marko.convert(content)), type="html")
    fg.atom_file(filename)

def main(token, repo_name, issue_number=None):
    auth = Auth.Token(token)
    gh = Github(auth=auth)
    me = get_me(gh)
    repo = gh.get_repo(repo_name)
    
    md_path = "README.md"
    # åˆå§‹åŒ– Header
    with open(md_path, "w", encoding="utf-8") as md:
        md.write(MD_HEAD)
    
    # æ¸²æŸ“å„ä¸ªç‰ˆå—
    add_md_top(repo, md_path, me)
    add_md_recent(repo, md_path, me)
    
    with open(md_path, "a+", encoding="utf-8") as md:
        md.write("## ğŸ“‚ Collections / æ–‡ç« åˆ†ç±»\n\n")
    
    add_md_label(repo, md_path, me)
    add_md_footer(md_path, me)
    
    generate_rss_feed(repo, "feed.xml", me)
    
    # å¤‡ä»½ Issue
    if not os.path.exists(BACKUP_DIR): os.mkdir(BACKUP_DIR)
    for issue in repo.get_issues(state="open"):
        if issue.user.login == me and not issue.pull_request:
            safe_title = re.sub(r'[\\/:*?"<>|]', '_', issue.title)
            with open(os.path.join(BACKUP_DIR, f"{issue.number}_{safe_title}.md"), "w", encoding="utf-8") as f:
                f.write(f"# [{issue.title}]({issue.html_url})\n\n{issue.body}")

if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument("github_token"); parser.add_argument("repo_name")
    parser.add_argument("--issue_number", default=None)
    args = parser.parse_args()
    main(args.github_token, args.repo_name, args.issue_number)
