name: Generate GitBlog README

on:
  # 1. ç›‘å¬ Issue çš„åŠ¨ä½œ
  issues:
    types: [opened, edited, labeled, unlabeled, deleted, closed, reopened]
  
  # 2. ç›‘å¬ Issue è¯„è®ºï¼ˆå¦‚æœä½ åœ¨ main.py é‡Œæœ‰å¤„ç†è¯„è®ºçš„é€»è¾‘ï¼Œæ¯”å¦‚å‹æƒ…é“¾æ¥ï¼‰
  issue_comment:
    types: [created, edited, deleted]

  # 3. ç›‘å¬ä»£ç æ¨é€ï¼ˆå½“ä½ æ‰‹åŠ¨ä¿®æ”¹ main.py æˆ– index.html æ—¶è§¦å‘ï¼‰
  push:
    branches:
      - master
      - main
    paths:
      - 'main.py'
      - '.github/workflows/*.yml'

  # 4. æ”¯æŒæ‰‹åŠ¨è§¦å‘ï¼ˆåœ¨ Actions é¡µé¢ç‚¹å‡»æŒ‰é’®è¿è¡Œï¼‰
  workflow_dispatch:

jobs:
  sync:
    name: Generate README
    runs-on: ubuntu-latest
    # ä»…å½“ä»“åº“æ‰€æœ‰è€…æ“ä½œæ—¶æ‰è¿è¡Œï¼Œé˜²æ­¢åˆ«äººä¹±å¼€ Issue æ¶ˆè€—ä½ çš„ Action é¢åº¦
    if: github.event.issue.user.login == github.repository_owner || github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install PyGithub feedgen marko lxml

      - name: Generate Content
        env:
          GH_TOKEN: ${{ secrets.G_T }}
          GITHUB_NAME: ${{ github.repository_owner }}
        run: |
          # è¿è¡Œä½ çš„è„šæœ¬
          python main.py "$GH_TOKEN" "${{ github.repository }}"
          
      - name: Push updates
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          # å¼ºåˆ¶æ·»åŠ æ‰€æœ‰å¯èƒ½å˜æ›´çš„æ–‡ä»¶
          git add README.md BACKUP/*.md _sidebar.md feed.xml
          # åªæœ‰åœ¨æœ‰å˜åŒ–æ—¶æ‰æäº¤ï¼Œé˜²æ­¢æŠ¥é”™
          git commit -m "chore: ğŸ¤– è‡ªåŠ¨æ›´æ–°åšæ–‡ [skip ci]" || echo "nothing to commit"
          git push || echo "nothing to push"
